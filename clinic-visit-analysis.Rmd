---
title: 'Descriptive statistics on patient follow-up'
author: 'Peter Kamerman and Prinisha Pillay'
date: "`r format(Sys.Date(), '%d %B %Y')`"
output: 
    html_document:
        theme: yeti
        highlight: pygments
        code_folding: show
        toc: true
        toc_float: true
        df_print: paged
---

****

**This analysis script describes patient follow-up.**

****

```{r setup, include = FALSE}
# Load packages
library(coin)
library(dplyr)
library(ggplot2)
library(patchwork)
library(tidyr)

# knitr options
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE, 
                      cache = TRUE,
                      fig.align = 'center',
                      fig.path = './figures/clinic-visit-analysis/')

# Load cleaned data
df <- readr::read_rds('./data/clean_data.rds')
```

# Quick data inspection
```{r quick_look}
dim(df)
names(df)
head(df)
tail(df)
glimpse(df)
```

# Did neuropathy develop?

Add a column indicating whether a patient develop SN at any stage of the follow.

```{r sn_indicator}
# Did they develop sn at any time?
sn <- df %>%
    select(ID, visit_number, hivsn_present) %>%
    group_by(ID) %>%
    mutate(max_visit = max(visit_number)) %>%
    filter(visit_number == max_visit) %>%
    select(ID, hivsn_present) %>%
    rename(sn = hivsn_present)

# Join SN indicator to df
df <- df %>%
    left_join(sn)
```

# Plots
## Clinic visits (whole cohort)
```{r plot_overview, fig.height = 8}
df %>%
    # Process data for plotting
    group_by(ID) %>%
    mutate(visit = ifelse(visit_day > 0,
                          yes = 1,
                          no = 0),
           visit_count = cumsum(visit),
           max_visits = max(visit_count),
           max_duration = max(visit_day)) %>%
    ungroup() %>%
    select(ID, visit_day, visit_months, 
           visit_count, max_visits, 
           max_duration) %>%
    # Clean-up and order dataframe
    arrange(max_duration, max_visits, desc(ID)) %>%
    mutate(ID = forcats::as_factor(ID),
           visit_count = as.character(visit_count)) %>%
    complete(ID, visit_months) %>%
    # Add a dummy variable for faceting
    bind_cols(facet = c(rep('Panel 1', 420), rep('Panel 2', 832-420))) %>%
    # Clean-up and order dataframe
    filter(complete.cases(.)) %>%
    # Plot
    ggplot(data = .) +
    aes(x = visit_day,
        y = ID) +
    geom_path(colour = '#888888') +
    geom_point(aes(fill = visit_count),
               shape = 21, 
               size = 3) +
    scale_x_continuous(breaks = seq(0, 250, 25)) +
    scale_fill_brewer() +
    labs(title = 'Timing of clinic visits',
         subtitle = '(Visit number coded by fill colour)') +
    facet_wrap(~facet, 
               ncol = 2, 
               scales = 'free_y') +
    theme(legend.position = 'top',
          panel.grid.major.y = element_blank())
```

## Clinic visits (SN+ vs SN-)
```{r plot_sn, fig.height = 8}
df %>%
    # Process data for plotting
    group_by(ID) %>%
    mutate(visit = ifelse(visit_day > 0,
                          yes = 1,
                          no = 0),
           visit_count = cumsum(visit),
           max_visits = max(visit_count),
           max_duration = max(visit_day)) %>%
    ungroup() %>%
    select(ID, hivsn_present, visit_day, visit_months, 
           visit_count, max_visits, 
           max_duration) %>%
    # Join with sn developed info (as a facetting factor)
    left_join(sn) %>%
    # Clean-up and order dataframe
    arrange(max_duration, max_visits, desc(ID)) %>%
    mutate(ID = forcats::as_factor(ID),
           visit_count = as.character(visit_count)) %>%
    complete(ID, visit_months) %>%
    # Clean-up and order dataframe
    filter(complete.cases(.)) %>%
    # Recode facetting column
    mutate(sn = as.character(sn),
           sn = ifelse(sn == 'yes',
                       yes = 'SN+',
                       no = 'SN-')) %>%
    # Plot
    ggplot(data = .) +
    aes(x = visit_day,
        y = ID) +
    geom_path(colour = '#888888') +
    geom_point(aes(fill = hivsn_present),
               shape = 21, 
               size = 3) +
    labs(title = 'Timing of clinic visits, facetted by whether SN developed',
         subtitle = '(Time-points were SN was present coded by fill colour)') +
    scale_x_continuous(breaks = seq(0, 250, 25)) +
    scale_fill_manual(values = c('#FFFFFF', 'red')) +
    facet_wrap(~ sn, 
               ncol = 2, 
               scales = 'free_y') +
    theme(legend.position = 'top',
          panel.grid.major.y = element_blank())
```

# Analysis
## Generate data
```{r visit_data}
# Generate visit data
df_v1 <- df %>%
    # Calculations per individual
    group_by(ID) %>%
    mutate(# Extract the max number of visits
           max_visits = max(visit_number), 
           # Time from visit 1 to the last visit
           max_duration = max(visit_day), 
           # Time between successive visits
           visit_break = visit_day - lag(visit_day),
           # Running mean time (days) between visits
           cummulative_mean = round(cummean(visit_day))) %>% 
    # Select required columns
    select(ID, visit_number, visit_day, visit_break, max_visits, 
           max_duration, cummulative_mean) %>%
    left_join(sn) %>%
    ungroup()

# Filter based on maximum number of visits
df_v2 <- df_v1 %>%
    # Per individual
    group_by(ID) %>%
    # Get maximum number of visits
    filter(visit_number == max_visits) %>%
    ungroup()
```

## Number of clinic visits
```{r n_visits}
# Summary table
df_v2 %>%
    summarise(Median = median(max_visits),
              IQR = paste0(quantile(max_visits, 0.25), ' - ',
                           quantile(max_visits, 0.75)),
              Range = paste0(min(max_visits), ' - ',
                             max(max_visits)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Number of clinic visits (whole cohort)',
                digits = 1,
                align = 'rrrr')

# Summary table (conditioned on sn)
df_v2 %>%
    group_by(sn) %>%
    summarise(Median = median(max_visits),
              IQR = paste0(quantile(max_visits, 0.25), ' - ',
                           quantile(max_visits, 0.75)),
              Range = paste0(min(max_visits), ' - ',
                             max(max_visits)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Number of clinic visits (by SN status)',
                digits = 1,
                align = 'lrrrr')

# Plots
## Univariate
foo <- df_v2 %>%
    group_by(max_visits) %>%
    summarise(count = n()) %>%
    mutate(visits = forcats::fct_relevel(factor(max_visits), '5', '4', '3')) %>%
    ggplot(data = .) +
    aes(y = count,
        x = 'all',
        fill = visits) +
    geom_bar(stat = 'identity') +
    labs(title = 'Number of clinic visits (counts)',
         subtitle = '(All participants)') +
    theme_bw() +
    theme(axis.title.x = element_blank())

bar <- df_v2 %>%
    group_by(max_visits) %>%
    summarise(count = n()) %>%
    mutate(visits = forcats::fct_relevel(factor(max_visits), '5', '4', '3')) %>%
    ggplot(data = .) +
    aes(y = count,
        x = 'all',
        fill = visits) +
    geom_bar(stat = 'identity', 
             position = position_fill()) +
    labs(title = 'Number of clinic visits (proportion)',
         subtitle = '(All participants)',
         y = 'proportion') +
    theme_bw() +
    theme(axis.title.x = element_blank())

# Plot next to each other using patchwork package
foo + bar

## Conditional on SN
baz <- df_v2 %>%
    group_by(sn, max_visits) %>%
    summarise(count = n()) %>%
    mutate(visits = forcats::fct_relevel(factor(max_visits), '5', '4', '3')) %>%
    ggplot(data = .) +
    aes(y = count,
        x = sn,
        fill = visits) +
    geom_bar(stat = 'identity') +
    labs(title = 'Number of clinic visits (counts)',
         subtitle = '(All participants)') +
    theme_bw() 

cuz <- df_v2 %>%
    group_by(sn, max_visits) %>%
    summarise(count = n()) %>%
    mutate(visits = forcats::fct_relevel(factor(max_visits), '5', '4', '3')) %>%
    ggplot(data = .) +
    aes(y = count,
        x = sn,
        fill = visits) +
    geom_bar(stat = 'identity', 
             position = position_fill()) +
    labs(title = 'Number of clinic visits (proportion)',
         subtitle = '(All participants)',
         y = 'proportion') +
    theme_bw()

# Plot next to each other using patchwork package
baz + cuz

# Stats
set.seed(1234)
## Significance test
## (Fisher-Pitman Permutation Test)
oneway_test(max_visits ~ factor(sn), 
            data = df_v2,
            distribution = 'exact')
```

## Time between first and last visit
```{r time_visits}
# Summary table
df_v2 %>%
    summarise(Median = median(max_duration),
              IQR = paste0(quantile(max_duration, 0.25), ' - ',
                           quantile(max_duration, 0.75)),
              Range = paste0(min(max_duration), ' - ',
                             max(max_duration)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Days between first and last clinic visit (whole cohort)',
                digits = 1,
                align = 'rrrr')

# Summary table (conditioned on sn)
df_v2 %>%
    group_by(sn) %>%
    summarise(Median = median(max_duration),
              IQR = paste0(quantile(max_duration, 0.25), ' - ',
                           quantile(max_duration, 0.75)),
              Range = paste0(min(max_duration), ' - ',
                             max(max_duration)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Days between first and last clinic visit (by sn status)',
                digits = 1,
                align = 'lrrrr')

# Plots
## Univariate
df_v2 %>%
    ggplot(data = .) +
    aes(y = max_duration, 
        x = 'All patients') +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'Days between first and last clinic visit ',
         subtitle = '(All participants)') +
    theme_bw() +
    theme(axis.title.x = element_blank())

## Conditional on SN
df_v2 %>%
    ggplot(data = .) +
    aes(y = max_duration, 
        x = sn) +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'Days between first and last clinic visit ',
         subtitle = '(SN+ vs SN-)') +
    theme_bw() 

# Stats
set.seed(1234)
## Significance test
## (Fisher-Pitman Permutation Test)
oneway_test(max_duration ~ factor(sn), 
            data = df_v2,
            distribution = 'exact')
```

## Time between successive clinic visits
```{r cummulative_visits}
# Summary table
df_v1 %>%
    filter(visit_number != 1) %>%
    group_by(visit_number) %>%
    summarise(Median = median(visit_break),
              IQR = paste0(quantile(visit_break, 0.25), ' - ',
                           quantile(visit_break, 0.75)),
              Range = paste0(min(visit_break), ' - ',
                             max(visit_break)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Days between successive clinic visits (whole cohort)',
                digits = 1,
                align = 'rrrr')

# Summary table (conditioned on sn)
df_v1 %>%
    filter(visit_number != 1) %>% 
    group_by(sn, visit_number) %>%
    summarise(Mean = mean(visit_break),
              SD = sd(visit_break),
              Range = paste0(min(visit_break), ' - ',
                             max(visit_break)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Days between successive clinic visits (by sn status)',
                digits = 1,
                align = 'lrrrr')

# Plots
## Univariate
df_v1 %>%
    filter(visit_number != 1) %>%
    ggplot(data = .) +
    aes(y = visit_break, 
        x = factor(visit_number)) +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'Days between successive clinic visit ',
         subtitle = '(All participants)') +
    theme_bw() 

## Conditional on SN
df_v1 %>%
    filter(visit_number != 1) %>%
    ggplot(data = .) +
    aes(y = visit_break, 
        x = factor(visit_number),
        fill = sn,
        colour = sn) +
    geom_boxplot(alpha = 0.6) +
    geom_point(position = position_jitterdodge(jitter.height = 0)) +
    labs(title = 'Days between successive clinic visits',
         subtitle = '(SN+ vs SN-)') +
    theme_bw() 

# Stats
## Generate date
df_lmer <- df_v1 %>%
    filter(visit_number != 1) %>%
    select(ID, visit_number, visit_break, sn) %>%
    mutate(visit_number = factor(visit_number, ordered = TRUE))

## Generate model (ID and visit_number included as random effects)
mod <- lmerTest::lmer(visit_break ~ sn + (1|ID) + (1|visit_number), 
            data = df_lmer)

## Analysis of Deviance Table (Type II Wald F tests with Kenward-Roger df)
car::Anova(mod = mod, 
           type = 'II', 
           test.statistic = 'F')

## Basic diagnostics
plot(mod,
     main = 'Residuals vs Fitted') 
qqnorm(resid(mod))
qqline(resid(mod))
```

## Session information
```{r session_info, echo = FALSE}
# clean-up
rm(list = ls())

# Session information
sessionInfo()
```

