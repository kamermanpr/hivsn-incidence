---
title: 'Descriptive and univariate analyses'
author: 'Peter Kamerman and Prinisha Pillay'
date: "`r format(Sys.Date(), '%d %B %Y')`"
output: 
    html_document:
        theme: yeti
        highlight: pygments
        code_folding: show
        toc: true
        toc_float: true
        df_print: paged
---

****

**This script describes variables collected at baseline, and whether the variables were associated with the development of sensory neurpathy (SN) at any point during the follow-up period.**

The following columns of variables were not analysed: `pain` and `pain score` (related to SN itself, therefore not relevant at baseline when everyone was SN free), `*_record` (inconsistent patient records), `hba1c_percent` and `vitaminB12_pmol.l` (continuous numeric data was only used to classify individuals as having diabetes or vitamin B12 deficiency). `ID`, `clinic_code`, `visit_number`, `visit_day`, `hivsn_present`, `visit_months`, `sn` also were not analysed; they merely provide sorting and grouping information.

****

```{r setup, include = FALSE}
# Load packages
library(boot)
library(coin)
library(dplyr)
library(ggplot2)
library(tidyr)

# knitr options
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE, 
                      cache = TRUE,
                      fig.align = 'center',
                      fig.path = './figures/basic-analysis/')

# Load cleaned data
df <- readr::read_rds('./data/clean_data.rds')
```

# Quick data inspection
```{r quick_look}
dim(df)
names(df)
head(df)
tail(df)
glimpse(df)
```

# Process data
## Did neuropathy develop?

Add a column indicating whether a patient develop SN at any stage of the follow-up period, and then filter dataframe to only contain rows of data from visit 1.

```{r sn_indicator}
# Did they develop sn at any time?
sn <- df %>%
    select(ID, visit_number, hivsn_present) %>%
    group_by(ID) %>%
    mutate(max_visit = max(visit_number)) %>%
    filter(visit_number == max_visit) %>%
    select(ID, hivsn_present) %>%
    rename(sn = hivsn_present)

# Join SN indicator to df
df <- df %>%
    left_join(sn)

# Clean-up
rm(sn)

# Create a filtered dataframe 'df_v1', which only contains visit 1 rows
# This dataframe will be used for all the baseline charateristic analyses.
df_v1 <- filter(df, visit_number == 1)
```

## Take a look at longitudinal variables 

Have a look at the longitudinal variables `CD4_cell.ul` and `viral_load_copies.ml` before deciding whether they are worth including in the analysis.

### CD4
```{r cd4_longitude}
# Plot CD4 by ID
df %>%
    # Remove missing values
    filter(!is.na(CD4_cell.ul)) %>%
    # Plot
    ggplot(data = .) +
    aes(x = visit_day,
        y = CD4_cell.ul,
        colour = ID) +
    geom_line() +
    geom_point() +
    labs(title = 'Spaghetti plot of CD4 T-cell count (cells/ul)',
         subtitle = '(Individual responses)') +
    scale_x_continuous(breaks = c(0, 50, 100, 150, 200, 250),
                       limits = c(0, max(df$visit_day))) +
    theme_bw() +
    theme(legend.position = 'none')

# Plot CD4 loess smoother (conditioned on sn)
df %>%
    # Remove missing values
    filter(!is.na(CD4_cell.ul)) %>%
    # Plot
    ggplot(data = .) +
    aes(x = visit_day,
        y = CD4_cell.ul,
        colour = sn) +
    geom_point() +
    geom_smooth(level = 0.834) +
    labs(title = 'Summary plot of CD4 T-cell count (cells/ul)',
         subtitle = '(SN+ vs SN-)',
         caption = '83.4% CI used based on Knol et al., 2011 (DOI 10.1007/s10654-011-9563-8)') +
    scale_x_continuous(breaks = c(0, 50, 100, 150, 200, 250),
                       limits = c(0, max(df$visit_day))) +
    theme_bw() 
```

### Viral load (log10)
```{r vl_longitude}
# Plot viral load by ID
df %>%
    # Remove missing values
    filter(!is.na(viral_load_copies.ml)) %>%
    # Plot
    ggplot(data = .) +
    aes(x = visit_day,
        y = viral_load_copies.ml,
        colour = ID) +
    geom_line() +
    geom_point() +
    labs(title = 'Spaghetti plot of viral load (log10(copies/ml))',
         subtitle = '(Individual responses)',
         y = 'log10(viral_load_copies.ml)') +
    scale_x_continuous(breaks = c(0, 50, 100, 150, 200, 250),
                       limits = c(0, max(df$visit_day))) +
    theme_bw() +
    theme(legend.position = 'none')

# Plot viral load loess smoother (conditioned on sn)
df %>%
    # Remove missing values
    filter(!is.na(viral_load_copies.ml)) %>%
    # Plot
    ggplot(data = .) +
    aes(x = visit_day,
        y = viral_load_copies.ml,
        colour = sn) +
    geom_point() +
    geom_smooth(level = 0.834) +
    labs(title = 'Spaghetti plot of viral load (log10(copies/ml))',
         subtitle = '(SN+ vs SN-)',
         caption = '83.4% CI used based on Knol et al., 2011 (DOI 10.1007/s10654-011-9563-8)',
         y = 'log10(viral_load_copies.ml)') +
    scale_x_continuous(breaks = c(0, 50, 100, 150, 200, 250),
                       limits = c(0, max(df$visit_day))) +
    theme_bw() 
```

Visual inspection indicates that neither CD4 T-cell count nor viral load show any major difference between the SN+ and SN- group, and therefore there is no significant benefit of including these longitudinal data in the model. 

# Bootstrap functions

Construct functions to calculate the 95% confidence interval of the mean/median/proportion difference, which can be used by the `boot` package. 

```{r boot}
# Calculate mean difference between SN+ and SN-
mean_delta <- function(d, i){
    # Supply with a two-column dataframe 
    # First column is numeric variable, second column is 'sn' status
    foo <- d[i, ]
    sn <- filter(foo, sn == 'yes')
    no <- filter(foo, sn == 'no')
    sn_mean <- mean(sn[[1]], na.rm = TRUE)
    no_mean <- mean(no[[1]], na.rm = TRUE)
    delta <- no_mean - sn_mean
    delta
}

# Calculate median difference between SN+ and SN-
median_delta <- function(d, i){
    # Supply with a two-column dataframe 
    # First column is numeric variable, second column is 'sn' status
    foo <- d[i, ]
    sn <- filter(foo, sn == 'yes')
    no <- filter(foo, sn == 'no')
    sn_median <- median(sn[[1]], na.rm = TRUE)
    no_median <- median(no[[1]], na.rm = TRUE)
    delta <- no_median - sn_median
    delta
}

# Calculate mean difference in proportion between SN+ and SN-
odds_ratio <- function(d, i){
    # Supply with a two-column dataframe 
    # First column is a dichotomous variable, second column is 'sn' status
    foo <- d[i, ]
    tab <- table(foo)
    odds_ratio <- epitools::oddsratio(tab, 
                                      method = 'fisher')$measure[2, 1]
    odds_ratio
}
```
# Analyses

## Age
```{r age}
# Summary table
df_v1 %>%
    filter(!is.na(age_years)) %>%
    summarise(Mean = mean(age_years),
              SD = sd(age_years),
              Range = paste0(min(age_years), ' - ',
                             max(age_years)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Age (years) (whole cohort)',
                digits = 1,
                align = 'rrrr')

# Summary table (conditional on sn)
df_v1 %>%
    filter(!is.na(age_years)) %>%
    group_by(sn) %>%
    summarise(Mean = mean(age_years),
              SD = sd(age_years),
              Range = paste0(min(age_years), ' - ',
                             max(age_years)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Age (years) (by SN status)',
                digits = 1,
                align = 'lrrrr')

# Plots
## Univariate
df_v1 %>%
    ggplot(data = .) +
    aes(y = age_years, 
        x = 'All patients') +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'Age at recruitment',
         subtitle = '(All participants)') +
    theme_bw() +
    theme(axis.text.x = element_blank())

## Conditional on SN
df_v1 %>%
    ggplot(data = .) +
    aes(y = age_years, 
        x = sn) +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'Age at recruitment',
         subtitle = '(SN+ vs SN-)') +
    theme_bw() 

# Stats
set.seed(1234)
## Significance test
## (Fisher-Pitman Permutation Test)
oneway_test(age_years ~ factor(sn), 
            data = df_v1,
            distribution = 'exact')

## 95% confidence interval of the mean difference
## (Bootstrap CI using bias-corrected accelerated method)
boot.ci(
    boot(data = select(df_v1, age_years, sn), 
         statistic = mean_delta, 
         R = 1000, 
         stype = 'i'),
    type = 'bca')
```

## Body mass
```{r mass}
# Summary table
df_v1 %>%
    filter(!is.na(mass_kg)) %>%
    summarise(Mean = mean(mass_kg),
              SD = sd(mass_kg),
              Range = paste0(min(mass_kg), ' - ',
                             max(mass_kg)),  
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Body mass (kg) (whole cohort)',
                digits = 1,
                align = 'rrrr')

# Summary table (conditional on sn)
df_v1 %>%
    filter(!is.na(mass_kg)) %>%
    group_by(sn) %>%
    summarise(Mean = mean(mass_kg),
              SD = sd(mass_kg),
              Range = paste0(min(mass_kg), ' - ',
                             max(mass_kg)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Body mass (kg) (by SN status)',
                digits = 1,
                align = 'llrrrr')

# Plots
## Univariate
df_v1 %>%
    ggplot(data = .) +
    aes(y = mass_kg, 
        x = 'All patients') +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'Body mass at recruitment',
         subtitle = '(All participants)') +
    theme_bw() +
    theme(axis.text.x = element_blank())

## Conditional on SN
df_v1 %>%
    ggplot(data = .) +
    aes(y = mass_kg, 
        x = sn) +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'Body mass at recruitment',
         subtitle = '(SN+ vs SN-)') +
    theme_bw() 

## Conditional on SN and Sex
df_v1 %>%
    ggplot(data = .) +
    aes(y = mass_kg, 
        x = sn) +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'Body mass at recruitment, grouped by sex',
         subtitle = '(SN+ vs SN-)') +
    facet_grid(. ~ sex) +
    theme_bw() 

## Possible sex influence

# Stats
set.seed(1234)
## Significance test
## (Fisher-Pitman Permutation Test)
oneway_test(mass_kg ~ factor(sn), 
            data = df_v1,
            distribution = 'exact')

## 95% confidence interval of the mean difference
## (Bootstrap CI using bias-corrected accelerated method)
boot.ci(
    boot(data = select(df_v1, mass_kg, sn), 
         statistic = mean_delta, 
         R = 1000, 
         stype = 'i'),
    type = 'bca')
```

## Height
Expect height to show sex difference, so analyse seperately for males and females.
```{r height}
# Summary table
df_v1 %>%
    filter(!is.na(height_m)) %>%
    group_by(sex) %>% # expect sex difference
    summarise(Mean = mean(height_m),
              SD = sd(height_m),
              Range = paste0(min(height_m), ' - ',
                             max(height_m)),
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Height (m), grouped by sex (whole cohort)',
                digits = 2,
                align = 'lrrrr')

# Summary table (conditional on sn)
df_v1 %>%
    filter(!is.na(height_m)) %>%
    group_by(sn, sex) %>%
    summarise(Mean = mean(height_m),
              SD = sd(height_m),
              Range = paste0(min(height_m), ' - ',
                             max(height_m)),
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Height (m), grouped by sex (by SN status)',
                digits = 2,
                align = 'llrrrr')

# Plots
## Univariate
df_v1 %>%
    ggplot(data = .) +
    aes(y = height_m, 
        x = sex) +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'Height at recruitment, grouped by sex',
         subtitle = '(All participants)') +
    theme_bw() 

## Conditional on SN
df_v1 %>%
    ggplot(data = .) +
    aes(y = height_m, 
        x = sn) +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'Height at recruitment, grouped by sex',
         subtitle = '(SN+ vs SN-)') +
    facet_grid(. ~ sex) +
    theme_bw() 

# Stats
set.seed(1234)
## Significance test
## (Fisher-Pitman Permutation Test)
### Male vs female (all)
oneway_test(height_m ~ factor(sex), 
            data = df_v1,
            distribution = 'exact')
### Females (by sn status)
df_v1 %>%
    filter(sex == 'F') %>%
    oneway_test(height_m ~ factor(sn), 
                data = .,
                distribution = 'exact')
### Male (by sn status)
df_v1 %>%
    filter(sex == 'M') %>%
    oneway_test(height_m ~ factor(sn), 
                data = .,
                distribution = 'exact')

## 95% confidence interval of the mean difference
## (Bootstrap CI using bias-corrected accelerated method)
### Females 
boot.ci(
    boot(data = select(df_v1[df_v1$sex == 'F', ], height_m, sn), 
         statistic = mean_delta, 
         R = 1000, 
         stype = 'i'),
    type = 'bca')
### Males 
boot.ci(
    boot(data = select(df_v1[df_v1$sex == 'M', ], height_m, sn), 
         statistic = mean_delta, 
         R = 1000, 
         stype = 'i'),
    type = 'bca')
```

## Sex
```{r sex}
# Summary table
df_v1 %>%
    filter(!is.na(sex)) %>%
    group_by(sex) %>%
    summarise(Count = n(),
              Proportion = round(Count / nrow(.), 2)) %>%
    knitr::kable(.,
                caption = 'Sex frequency (whole cohort)',
                digits = 2)

# Summary table (conditional on sn)
df_v1 %>%
    filter(!is.na(sex)) %>%
    group_by(sn, sex) %>%
    summarise(Count = n(),
              Proportion = round(Count / nrow(.), 2)) %>%
    knitr::kable(.,
                caption = 'Sex frequency (by SN status)',
                digits = 2)
# Plots
## Univariate
df_v1 %>%
    ggplot(data = .) +
    aes(x = visit_number,
        fill = sex) +
    geom_bar(position = 'fill') + 
    geom_hline(yintercept = 0.5,
               linetype = 2) +
    labs(title = 'Sex ratio at recruitment',
         subtitle = '(All participants)',
         y = 'proportion') +
    theme_bw() +
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank())

## Conditional on SN
df_v1 %>%
    ggplot(data = .) +
    aes(x = sn,
        fill = sex) +
    geom_bar(position = 'fill') +
    geom_hline(yintercept = 0.5,
               linetype = 2) +
    labs(title = 'Sex ratio at recruitment',
         subtitle = '(SN+ vs SN-)',
         y = 'proportion') +
    theme_bw() 

# Stats
set.seed(1234)
## Significance test
## (Chi-squared test)
chisq_test(factor(sex) ~ factor(sn), 
           data = df_v1,
           distribution = 'exact')

## 95% confidence interval of the odds ratio, caculated using 
## the conditional maximum likelihood estimation (Fisher) method
## (reference group: Female)
## (Bootstrap CI using bias-corrected accelerated method)
boot.ci(
    boot(data = select(df_v1, sex, sn), 
         statistic = odds_ratio, 
         R = 1000, 
         stype = 'i'),
    type = 'bca')
```

## CD4 T-cell count
```{r cd4}
# Summary table
df_v1 %>%
    filter(!is.na(CD4_cell.ul)) %>%
    summarise(Median = median(CD4_cell.ul),
              IQR = paste0(quantile(CD4_cell.ul, 0.25), ' - ',
                           quantile(CD4_cell.ul, 0.75)),
              Range = paste0(min(CD4_cell.ul), ' - ',
                             max(CD4_cell.ul)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'CD4 T-cell count (cell/ul) (whole cohort)',
                digits = 1,
                align = 'rrrr')

# Summary table (conditional on sn)
df_v1 %>%
    filter(!is.na(CD4_cell.ul)) %>%
    group_by(sn) %>%
    summarise(Median = median(CD4_cell.ul),
              IQR = paste0(round(quantile(CD4_cell.ul, 0.25)), ' - ',
                           round(quantile(CD4_cell.ul, 0.75))),
              Range = paste0(min(CD4_cell.ul), ' - ',
                             max(CD4_cell.ul)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'CD4 T-cell count (cell/ul) (by SN status)',
                digits = 0,
                align = 'lrrrr')

# Plots
## Univariate
df_v1 %>%
    ggplot(data = .) +
    aes(y = CD4_cell.ul, 
        x = 'All patients') +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'CD4 T-cell count at recruitment',
         subtitle = '(All participants)') +
    theme_bw() +
    theme(axis.text.x = element_blank())

## Conditional on SN
df_v1 %>%
    ggplot(data = .) +
    aes(y = CD4_cell.ul, 
        x = sn) +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'CD4 T-cell count at recruitment',
         subtitle = '(SN+ vs SN-)') +
    theme_bw() 

# Stats
set.seed(1234)
## Significance test
## (Fisher-Pitman Permutation Test)
oneway_test(CD4_cell.ul ~ factor(sn), 
            data = df_v1,
            distribution = 'exact')

## 95% confidence interval of the median difference
## (Bootstrap CI using bias-corrected accelerated method)
boot.ci(
    boot(data = select(df_v1, CD4_cell.ul, sn), 
         statistic = median_delta, 
         R = 1000, 
         stype = 'i'),
    type = 'bca')
```

## Viral load
```{r viral_load}
# Summary table
df_v1 %>%
    filter(!is.na(viral_load_copies.ml)) %>%
    summarise(Median = median(viral_load_copies.ml),
              IQR = paste0(round(quantile(viral_load_copies.ml, 0.25), 2), 
                           ' - ',
                           round(quantile(viral_load_copies.ml, 0.75), 2)),
              Range = paste0(round(min(viral_load_copies.ml), 2), ' - ',
                             round(max(viral_load_copies.ml), 2)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Viral load [log10(copies/ml)] (whole cohort)',
                digits = 2,
                align = 'rrrr')

# Summary table (conditional on sn)
df_v1 %>%
    filter(!is.na(viral_load_copies.ml)) %>%
    group_by(sn) %>%
    summarise(Median = median(viral_load_copies.ml),
              IQR = paste0(round(quantile(viral_load_copies.ml, 0.25), 2), 
                           ' - ',
                           round(quantile(viral_load_copies.ml, 0.75), 2)),
              Range = paste0(round(min(viral_load_copies.ml), 2), ' - ',
                             round(max(viral_load_copies.ml), 2)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Viral load [log10(copies/ml)] (by SN status)',
                digits = 1,
                align = 'lrrrr')

# Plots
## Univariate
df_v1 %>%
    filter(!is.na(viral_load_copies.ml)) %>%
    ggplot(data = .) +
    aes(y = viral_load_copies.ml, 
        x = 'All patients') +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'CD4 T-cell count at recruitment',
         subtitle = '(All participants)',
         y = 'log10(viral_load_copies.ml)') +
    theme_bw() +
    theme(axis.text.x = element_blank())

## Conditional on SN
df_v1 %>%
    filter(!is.na(viral_load_copies.ml)) %>%
    ggplot(data = .) +
    aes(y = log10(viral_load_copies.ml), 
        x = sn) +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'CD4 T-cell count at recruitment',
         subtitle = '(SN+ vs SN-)',
         y = 'log10(viral_load_copies.ml)') +
    theme_bw() 

# Stats
set.seed(1234)
## Significance test
## (Fisher-Pitman Permutation Test)
df_v1 %>%
    filter(!is.na(viral_load_copies.ml)) %>%
    oneway_test(viral_load_copies.ml ~ factor(sn), 
                data = .)

## 95% confidence interval of the median difference
## (Bootstrap CI using bias-corrected accelerated method)
df_log.vl <- df_v1 %>%
    filter(!is.na(viral_load_copies.ml)) %>%
    select(viral_load_copies.ml, sn)

boot.ci(
    boot(data = df_log.vl, 
         statistic = median_delta, 
         R = 1000, 
         stype = 'i'),
    type = 'bca')

# Clean-up
rm(df_log.vl)
```

## Alcohol
### Consumes alcohol, yes or no?
```{r alcohol}
# Summary table
df_v1 %>%
    filter(!is.na(consumes_alcohol)) %>%
    group_by(consumes_alcohol) %>%
    summarise(Count = n(),
              Proportion = round(Count / nrow(.), 2)) %>%
    knitr::kable(.,
                caption = 'Consumes alcohol (whole cohort)',
                digits = 2)

# Summary table (conditional on sn)
df_v1 %>%
    filter(!is.na(consumes_alcohol)) %>%
    group_by(sn, consumes_alcohol) %>%
    summarise(Count = n(),
              Proportion = round(Count / nrow(.), 2)) %>%
    knitr::kable(.,
                caption = 'Consumes alcohol (by SN status)',
                digits = 2)
# Plots
## Univariate
df_v1 %>%
    ggplot(data = .) +
    aes(x = visit_number,
        fill = consumes_alcohol) +
    geom_bar(position = 'fill') + 
    geom_hline(yintercept = 0.5,
               linetype = 2) +
    labs(title = 'Consumes alcohol at recruitment',
         subtitle = '(All participants)',
         y = 'proportion') +
    theme_bw() +
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank())

## Conditional on SN
df_v1 %>%
    ggplot(data = .) +
    aes(x = sn,
        fill = consumes_alcohol) +
    geom_bar(position = 'fill') +
    geom_hline(yintercept = 0.5,
               linetype = 2) +
    labs(title = 'Consumes alcohol at recruitment',
         subtitle = '(SN+ vs SN-)',
         y = 'proportion') +
    theme_bw() 

# Stats
set.seed(1234)
## Significance test
## (Chi-squared test)
chisq_test(factor(consumes_alcohol) ~ factor(sn), 
           data = df_v1,
           distribution = 'exact')

## 95% confidence interval of the odds ratio, caculated using 
## the conditional maximum likelihood estimation (Fisher) method
## (reference group: No alcohol)
## (Bootstrap CI using bias-corrected accelerated method)
boot.ci(
    boot(data = select(df_v1, consumes_alcohol, sn), 
         statistic = odds_ratio, 
         R = 1000, 
         stype = 'i'),
    type = 'bca')
```

### Units of alcohol consumed per week
_(If a person consumes alcohol)_
```{r units_alcohol}
df_eoh <- df_v1 %>%
    filter(consumes_alcohol == 'yes') %>%
    select(alcohol_units.week, sn)

# Summary table
df_eoh %>%
    summarise(Median = median(alcohol_units.week),
              IQR = paste0(round(quantile(alcohol_units.week, 0.25), 2), 
                           ' - ',
                           round(quantile(alcohol_units.week, 0.75), 2)),
              Range = paste0(round(min(alcohol_units.week), 2), ' - ',
                             round(max(alcohol_units.week), 2)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Alcohol consumed (units/week) (whole cohort)',
                digits = 2,
                align = 'rrrr')

# Summary table (conditional on sn)
df_eoh %>%
    group_by(sn) %>%
    summarise(Median = median(alcohol_units.week),
              IQR = paste0(round(quantile(alcohol_units.week, 0.25), 2), 
                           ' - ',
                           round(quantile(alcohol_units.week, 0.75), 2)),
              Range = paste0(round(min(alcohol_units.week), 2), ' - ',
                             round(max(alcohol_units.week), 2)), 
              Count = n()) %>%
    knitr::kable(.,
                caption = 'Alcohol consumed (units/week) (by SN status)',
                digits = 1,
                align = 'lrrrr')

# Plots
## Univariate
df_eoh %>%
    ggplot(data = .) +
    aes(y = alcohol_units.week, 
        x = 'All patients') +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'Alcohol consumed (units/week) at recruitment',
         subtitle = '(All participants)') +
    theme_bw() +
    theme(axis.text.x = element_blank())

## Conditional on SN
df_eoh %>%
    ggplot(data = .) +
    aes(y = alcohol_units.week, 
        x = sn) +
    geom_boxplot() +
    geom_jitter(height = 0) +
    labs(title = 'Alcohol consumed (units/week) at recruitment',
         subtitle = '(SN+ vs SN-)') +
    theme_bw() 

# Stats
set.seed(1234)
## Significance test
## (Fisher-Pitman Permutation Test)
df_eoh %>%
    oneway_test(alcohol_units.week ~ factor(sn), 
                data = .,
                distribution = 'exact')

## 95% confidence interval of the median difference
## (Bootstrap CI using bias-corrected accelerated method)
boot.ci(
    boot(data = df_eoh, 
         statistic = median_delta, 
         R = 1000, 
         stype = 'i'),
    type = 'bca')

# Clean-up
rm(df_eoh)
```

## TB infection/treatment
### Do you currently have TB?
```{r tb_current}
# Summary table
df_v1 %>%
    filter(!is.na(TB_current)) %>%
    group_by(TB_current) %>%
    summarise(Count = n(),
              Proportion = round(Count / nrow(.), 2)) %>%
    knitr::kable(.,
                caption = 'Currently has TB infection (whole cohort)',
                digits = 2)

# Summary table (conditional on sn)
df_v1 %>%
    filter(!is.na(TB_current)) %>%
    group_by(sn, TB_current) %>%
    summarise(Count = n(),
              Proportion = round(Count / nrow(.), 2)) %>%
    knitr::kable(.,
                caption = 'Currently has TB infection (by SN status)',
                digits = 2)
# Plots
## Univariate
df_v1 %>%
    ggplot(data = .) +
    aes(x = visit_number,
        fill = TB_current) +
    geom_bar(position = 'fill') + 
    geom_hline(yintercept = 0.5,
               linetype = 2) +
    labs(title = 'Current TB infection at recruitment',
         subtitle = '(All participants)',
         y = 'proportion') +
    theme_bw() +
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank())

## Conditional on SN
df_v1 %>%
    ggplot(data = .) +
    aes(x = sn,
        fill = TB_current) +
    geom_bar(position = 'fill') +
    geom_hline(yintercept = 0.5,
               linetype = 2) +
    labs(title = 'Current TB infection at recruitment',
         subtitle = '(SN+ vs SN-)',
         y = 'proportion') +
    theme_bw() 

# Stats
set.seed(1234)
## Significance test
## (Chi-squared test)
chisq_test(factor(TB_current) ~ factor(sn), 
           data = df_v1,
           distribution = 'exact')

## 95% confidence interval of the odds ratio, caculated using 
## the conditional maximum likelihood estimation (Fisher) method
## (reference group: No TB)
## (Bootstrap CI using bias-corrected accelerated method)
boot.ci(
    boot(data = select(df_v1, TB_current, sn), 
         statistic = odds_ratio, 
         R = 1000, 
         stype = 'i'),
    type = 'bca')
```

### Currently receiving TB treatment?

Treatment consists of rifafour and pyridoxine (prophylaxis). Therefore only need to analyse rifafour data. _Note: Treatment policy was to start some patients, irrespective of TB diagnosis, on TB treatment._

```{r tb_rifafour}
# Double-check matching between rifafour and pyridoxine columns 
unique(df_v1$rifafour_treatment == df_v1$pyridoxine_prophylaxis)

# Summary table
df_v1 %>%
    filter(!is.na(rifafour_treatment)) %>%
    group_by(rifafour_treatment) %>%
    summarise(Count = n(),
              Proportion = round(Count / nrow(.), 2)) %>%
    knitr::kable(.,
                caption = 'Currently receiving rifafour/pryridoxine (whole cohort)',
                digits = 2)

# Summary table (conditional on sn)
df_v1 %>%
    filter(!is.na(rifafour_treatment)) %>%
    group_by(sn, rifafour_treatment) %>%
    summarise(Count = n(),
              Proportion = round(Count / nrow(.), 2)) %>%
    knitr::kable(.,
                caption = 'Currently receiving rifafour/pryridoxine (by SN status)',
                digits = 2)
# Plots
## Univariate
df_v1 %>%
    ggplot(data = .) +
    aes(x = visit_number,
        fill = rifafour_treatment) +
    geom_bar(position = 'fill') + 
    geom_hline(yintercept = 0.5,
               linetype = 2) +
    labs(title = 'Receiving rifafour/pryridoxine at recruitment',
         subtitle = '(All participants)',
         y = 'proportion') +
    theme_bw() +
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank())

## Conditional on SN
df_v1 %>%
    ggplot(data = .) +
    aes(x = sn,
        fill = rifafour_treatment) +
    geom_bar(position = 'fill') +
    geom_hline(yintercept = 0.5,
               linetype = 2) +
    labs(title = 'Receiving rifafour/pryridoxine at recruitment',
         subtitle = '(SN+ vs SN-)',
         y = 'proportion') +
    theme_bw() 

# Stats
set.seed(1234)
## Significance test
## (Chi-squared test)
chisq_test(factor(rifafour_treatment) ~ factor(sn), 
           data = df_v1,
           distribution = 'exact')

## 95% confidence interval of the odds ratio, caculated using 
## the conditional maximum likelihood estimation (Fisher) method
## (reference group: No rifafour)
## (Bootstrap CI using bias-corrected accelerated method)
boot.ci(
    boot(data = select(df_v1, rifafour_treatment, sn), 
         statistic = odds_ratio, 
         R = 1000, 
         stype = 'i'),
    type = 'bca')
```

## Diabetes

Classed as diabetic based on `df_v1$hba1c_percent` > 7%. No one was diabetic.

```{r diabetes}
# Summary table
df_v1 %>%
    filter(!is.na(diabetic_hba1c)) %>%
    group_by(diabetic_hba1c) %>%
    summarise(Count = n(),
              Proportion = round(Count / nrow(.), 2)) %>%
    knitr::kable(.,
                caption = 'Diabetic (HBA1c > 7%) (whole cohort)',
                digits = 2)
```

## Vitamin B12 deficiency

Classed as B12 deficient based on `df_v1$vitaminB12_pmol.l` < 141 pmol/l. Only one person had a deficiency.

```{r vitaminB12}
# Summary table
df_v1 %>%
    filter(!is.na(vitaminB12_deficiency)) %>%
    group_by(vitaminB12_deficiency) %>%
    summarise(Count = n(),
              Proportion = round(Count / nrow(.), 2)) %>%
    knitr::kable(.,
                caption = 'B12 deficiency (B12 < 141 pmol/l) (whole cohort)',
                digits = 2)

# Did the persson with a deficiency develop sn?
df_v1[df_v1$vitaminB12_deficiency == 'yes' & !is.na(df_v1$vitaminB12_deficiency),
      c('vitaminB12_deficiency', 'sn')] %>%
    knitr::kable(.)
```

# Session information
```{r session_info, echo = FALSE}
# clean-up
rm(list = ls())

# Session information
sessionInfo()
```

